
#import <Foundation/Foundation.h>

NSString *StringFromDocumentData(Byte *data);


//: notification.db
Byte modulePolicyUnknownStandName[] = {14, 15, 94, 14, 31, 67, 52, 234, 76, 30, 34, 226, 96, 212, 204, 205, 210, 199, 196, 199, 193, 191, 210, 199, 205, 204, 140, 194, 192, 8};

//: timetag
Byte spacingPartyKey[] = {12, 7, 76, 5, 168, 192, 181, 185, 177, 192, 173, 179, 201};

//: create table if not exists notifications(serial integer primary key,                           timetag integer,sender text,receiver text,content text,status integer)
Byte kAlongError[] = {67, 165, 50, 13, 207, 82, 129, 13, 30, 129, 96, 164, 206, 149, 164, 151, 147, 166, 151, 82, 166, 147, 148, 158, 151, 82, 155, 152, 82, 160, 161, 166, 82, 151, 170, 155, 165, 166, 165, 82, 160, 161, 166, 155, 152, 155, 149, 147, 166, 155, 161, 160, 165, 90, 165, 151, 164, 155, 147, 158, 82, 155, 160, 166, 151, 153, 151, 164, 82, 162, 164, 155, 159, 147, 164, 171, 82, 157, 151, 171, 94, 82, 82, 82, 82, 82, 82, 82, 82, 82, 82, 82, 82, 82, 82, 82, 82, 82, 82, 82, 82, 82, 82, 82, 82, 82, 82, 82, 166, 155, 159, 151, 166, 147, 153, 82, 155, 160, 166, 151, 153, 151, 164, 94, 165, 151, 160, 150, 151, 164, 82, 166, 151, 170, 166, 94, 164, 151, 149, 151, 155, 168, 151, 164, 82, 166, 151, 170, 166, 94, 149, 161, 160, 166, 151, 160, 166, 82, 166, 151, 170, 166, 94, 165, 166, 147, 166, 167, 165, 82, 155, 160, 166, 151, 153, 151, 164, 91, 14};

//: create index if not exists timetagindex on notifications(timetag)
Byte featureVisitorError[] = {16, 65, 2, 4, 101, 116, 103, 99, 118, 103, 34, 107, 112, 102, 103, 122, 34, 107, 104, 34, 112, 113, 118, 34, 103, 122, 107, 117, 118, 117, 34, 118, 107, 111, 103, 118, 99, 105, 107, 112, 102, 103, 122, 34, 113, 112, 34, 112, 113, 118, 107, 104, 107, 101, 99, 118, 107, 113, 112, 117, 42, 118, 107, 111, 103, 118, 99, 105, 43, 54};

//: serial
Byte appReplacementValue[] = {16, 6, 52, 10, 76, 56, 161, 4, 117, 173, 167, 153, 166, 157, 149, 160, 27};

//: insert into notifications(timetag,sender,receiver,content,status)              values(?,?,?,?,?)
Byte commonSumSearchId[] = {66, 96, 95, 13, 217, 8, 77, 47, 109, 220, 178, 66, 238, 200, 205, 210, 196, 209, 211, 127, 200, 205, 211, 206, 127, 205, 206, 211, 200, 197, 200, 194, 192, 211, 200, 206, 205, 210, 135, 211, 200, 204, 196, 211, 192, 198, 139, 210, 196, 205, 195, 196, 209, 139, 209, 196, 194, 196, 200, 213, 196, 209, 139, 194, 206, 205, 211, 196, 205, 211, 139, 210, 211, 192, 211, 212, 210, 136, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 127, 213, 192, 203, 212, 196, 210, 135, 158, 139, 158, 139, 158, 139, 158, 139, 158, 136, 53};

//: update notifications set status  = ? where status < ? or status > ?
Byte moduleUniformFormat[] = {39, 67, 55, 13, 140, 77, 208, 249, 108, 133, 54, 187, 137, 172, 167, 155, 152, 171, 156, 87, 165, 166, 171, 160, 157, 160, 154, 152, 171, 160, 166, 165, 170, 87, 170, 156, 171, 87, 170, 171, 152, 171, 172, 170, 87, 87, 116, 87, 118, 87, 174, 159, 156, 169, 156, 87, 170, 171, 152, 171, 172, 170, 87, 115, 87, 118, 87, 166, 169, 87, 170, 171, 152, 171, 172, 170, 87, 117, 87, 118, 118};

//: sender
Byte themeDarkData[] = {7, 6, 43, 14, 45, 170, 218, 3, 152, 123, 188, 96, 108, 216, 158, 144, 153, 143, 144, 157, 183};

//: select count(serial) from notifications where status = ?
Byte widgetArgumentHelper[] = {82, 56, 52, 5, 9, 167, 153, 160, 153, 151, 168, 84, 151, 163, 169, 162, 168, 92, 167, 153, 166, 157, 149, 160, 93, 84, 154, 166, 163, 161, 84, 162, 163, 168, 157, 154, 157, 151, 149, 168, 157, 163, 162, 167, 84, 171, 156, 153, 166, 153, 84, 167, 168, 149, 168, 169, 167, 84, 113, 84, 115, 187};

//: update notifications set status  = ? where serial = ?
Byte themeTravelWatchKey[] = {19, 53, 60, 14, 63, 234, 51, 4, 215, 32, 101, 107, 6, 7, 177, 172, 160, 157, 176, 161, 92, 170, 171, 176, 165, 162, 165, 159, 157, 176, 165, 171, 170, 175, 92, 175, 161, 176, 92, 175, 176, 157, 176, 177, 175, 92, 92, 121, 92, 123, 92, 179, 164, 161, 174, 161, 92, 175, 161, 174, 165, 157, 168, 92, 121, 92, 123, 56};

//: receiver
Byte widgetAlongId[] = {28, 8, 87, 11, 151, 208, 141, 177, 162, 192, 253, 201, 188, 186, 188, 192, 205, 188, 201, 62};

//: select * from notifications where timetag < %f and status != ? order by timetag desc limit ?
Byte colorPolicyError[] = {71, 92, 22, 5, 164, 137, 123, 130, 123, 121, 138, 54, 64, 54, 124, 136, 133, 131, 54, 132, 133, 138, 127, 124, 127, 121, 119, 138, 127, 133, 132, 137, 54, 141, 126, 123, 136, 123, 54, 138, 127, 131, 123, 138, 119, 125, 54, 82, 54, 59, 124, 54, 119, 132, 122, 54, 137, 138, 119, 138, 139, 137, 54, 55, 83, 54, 85, 54, 133, 136, 122, 123, 136, 54, 120, 143, 54, 138, 127, 131, 123, 138, 119, 125, 54, 122, 123, 137, 121, 54, 130, 127, 131, 127, 138, 54, 85, 45};

//: update notifications set status  = ? where status = ?
Byte spacingStandKey[] = {18, 53, 54, 8, 144, 162, 81, 19, 171, 166, 154, 151, 170, 155, 86, 164, 165, 170, 159, 156, 159, 153, 151, 170, 159, 165, 164, 169, 86, 169, 155, 170, 86, 169, 170, 151, 170, 171, 169, 86, 86, 115, 86, 117, 86, 173, 158, 155, 168, 155, 86, 169, 170, 151, 170, 171, 169, 86, 115, 86, 117, 195};

//: content
Byte viewVerseFormat[] = {53, 7, 30, 12, 176, 44, 166, 69, 204, 164, 185, 215, 129, 141, 140, 146, 131, 140, 146, 60};

//: select * from notifications where status != ? order by timetag desc limit ?
Byte spacingExecuteConfig[] = {87, 75, 98, 11, 223, 232, 130, 248, 124, 145, 92, 213, 199, 206, 199, 197, 214, 130, 140, 130, 200, 212, 209, 207, 130, 208, 209, 214, 203, 200, 203, 197, 195, 214, 203, 209, 208, 213, 130, 217, 202, 199, 212, 199, 130, 213, 214, 195, 214, 215, 213, 130, 131, 159, 130, 161, 130, 209, 212, 198, 199, 212, 130, 196, 219, 130, 214, 203, 207, 199, 214, 195, 201, 130, 198, 199, 213, 197, 130, 206, 203, 207, 203, 214, 130, 161, 78};

//: create index if not exists readindex on notifications(status)
Byte styleNeatTitle[] = {25, 61, 66, 7, 76, 73, 219, 165, 180, 167, 163, 182, 167, 98, 171, 176, 166, 167, 186, 98, 171, 168, 98, 176, 177, 182, 98, 167, 186, 171, 181, 182, 181, 98, 180, 167, 163, 166, 171, 176, 166, 167, 186, 98, 177, 176, 98, 176, 177, 182, 171, 168, 171, 165, 163, 182, 171, 177, 176, 181, 106, 181, 182, 163, 182, 183, 181, 107, 18};

// __DEBUG__
// __CLOSE_PRINT__
//
//  AttachMeasuredSuiteTranslate.m
//  NIM
//
//  Created by chris on 15/5/26.
//  Copyright (c) 2015å¹´ Netease. All rights reserved.
//

// __M_A_C_R_O__
//: #import "AttachMeasuredSuiteTranslate.h"
#import "AttachMeasuredSuiteTranslate.h"
//: #import "FMDB.h"
#import "FMDB.h"
//: #import "LeanApply.h"
#import "LeanApply.h"
//: #import "AddBelowDropPlace.h"
#import "AddBelowDropPlace.h"

//: typedef NS_ENUM(NSInteger, AttachMeasuredSuiteTranslateStatus){
typedef NS_ENUM(NSInteger, AttachMeasuredSuiteTranslateStatus){
    //: AttachMeasuredSuiteTranslateStatusNone = 0,
    AttachMeasuredSuiteTranslateStatusNone = 0,
    //: AttachMeasuredSuiteTranslateStatusRead = 1,
    AttachMeasuredSuiteTranslateStatusRead = 1,
    //: AttachMeasuredSuiteTranslateStatusDeleted = 2,
    AttachMeasuredSuiteTranslateStatusDeleted = 2,
//: };
};

//: @interface AttachMeasuredSuiteTranslate ()
@interface AttachMeasuredSuiteTranslate ()
//: @property (nonatomic,strong) FMDatabase *db;
@property (nonatomic,strong) FMDatabase *checkIndex;
//: @end
@end


//: @implementation AttachMeasuredSuiteTranslate
@implementation AttachMeasuredSuiteTranslate

//: #pragma mark - Misc
#pragma mark - Misc
//: - (void)openDatabase
- (void)computerDatabase
{
    //: NSString *filepath = [[LeanApply userDirectory] stringByAppendingString:@"notification.db"];
    NSString *filepath = [[LeanApply fan] stringByAppendingString:StringFromDocumentData(modulePolicyUnknownStandName)];
    //: FMDatabase *db = [FMDatabase databaseWithPath:filepath];
    FMDatabase *db = [FMDatabase databaseWithPath:filepath];
    //: if ([db open])
    if ([db open])
    {
        //: _db = db;
        _checkIndex = db;
        //: NSArray *sqls = @[@"create table if not exists notifications(serial integer primary key,                           timetag integer,sender text,receiver text,content text,status integer)",
        NSArray *sqls = @[StringFromDocumentData(kAlongError),

                          //: @"create index if not exists readindex on notifications(status)",
                          StringFromDocumentData(styleNeatTitle),
                          //: @"create index if not exists timetagindex on notifications(timetag)"];
                          StringFromDocumentData(featureVisitorError)];
        //: for (NSString *sql in sqls)
        for (NSString *sql in sqls)
        {
            //: if (![_db executeUpdate:sql])
            if (![_checkIndex executeUpdate:sql])
            {
            }
        }
        //: [self queryUnreadCount];
        [self brokerTotal];
    }
    //: else
    else
    {
    }
};

//: - (void)deleteAllNotification{
- (void)relative{
    //: NSString *sql = @"update notifications set status  = ? where status < ? or status > ?";
    NSString *sql = StringFromDocumentData(moduleUniformFormat);
    //: io_async(^{
    overlookTechnology(^{
        //: if (![self.db executeUpdate:sql,@(AttachMeasuredSuiteTranslateStatusDeleted),@(AttachMeasuredSuiteTranslateStatusDeleted),@(AttachMeasuredSuiteTranslateStatusDeleted)])
        if (![self.checkIndex executeUpdate:sql,@(AttachMeasuredSuiteTranslateStatusDeleted),@(AttachMeasuredSuiteTranslateStatusDeleted),@(AttachMeasuredSuiteTranslateStatusDeleted)])
        {
        }
        //: [self queryUnreadCount];
        [self brokerTotal];
    //: });
    });
}


//: + (instancetype)sharedInstance { static AttachMeasuredSuiteTranslate *sharedAttachMeasuredSuiteTranslate = nil; static dispatch_once_t pred; _dispatch_once(&pred, ^{ sharedAttachMeasuredSuiteTranslate = [[AttachMeasuredSuiteTranslate alloc] init]; }); return sharedAttachMeasuredSuiteTranslate; };
+ (instancetype)instance { static AttachMeasuredSuiteTranslate *sharedAttachMeasuredSuiteTranslate = nil; static dispatch_once_t pred; _dispatch_once(&pred, ^{ sharedAttachMeasuredSuiteTranslate = [[AttachMeasuredSuiteTranslate alloc] init]; }); return sharedAttachMeasuredSuiteTranslate; }

//: - (void)markAllNotificationsAsRead{
- (void)behind{
    //: NSString *sql = @"update notifications set status  = ? where status = ?";
    NSString *sql = StringFromDocumentData(spacingStandKey);
    //: io_sync_safe(^{
    avoidAssociation(^{
        //: if (![self.db executeUpdate:sql,@(AttachMeasuredSuiteTranslateStatusRead),@(AttachMeasuredSuiteTranslateStatusNone)])
        if (![self.checkIndex executeUpdate:sql,@(AttachMeasuredSuiteTranslateStatusRead),@(AttachMeasuredSuiteTranslateStatusNone)])
        {
        }
        //: [self queryUnreadCount];
        [self brokerTotal];
    //: });
    });
}

//: - (void)queryUnreadCount{
- (void)brokerTotal{
    //: NSInteger count = 0;
    NSInteger count = 0;
    //: NSString *sql = @"select count(serial) from notifications where status = ?";
    NSString *sql = StringFromDocumentData(widgetArgumentHelper);
    //: FMResultSet *rs = [_db executeQuery:sql,@(AttachMeasuredSuiteTranslateStatusNone)];
    FMResultSet *rs = [_checkIndex executeQuery:sql,@(AttachMeasuredSuiteTranslateStatusNone)];
    //: if ([rs next])
    if ([rs next])
    {
        //: count = (NSInteger)[rs intForColumnIndex:0];
        count = (NSInteger)[rs intForColumnIndex:0];
    }
    //: [rs close];
    [rs close];

    //: if (count != _unreadCount)
    if (count != _album)
    {
        //: self.unreadCount = count;
        self.album = count;
    }
}

//: - (NSInteger)unreadCount
- (NSInteger)album
{
    //: __block NSInteger count = 0;
    __block NSInteger count = 0;
    //: io_sync_safe(^{
    avoidAssociation(^{
        //: count = _unreadCount;
        count = _album;
    //: });
    });
    //: return count;
    return count;
}


//: - (BOOL)saveNotification:(AddBelowDropPlace *)notification{
- (BOOL)tuneTower:(AddBelowDropPlace *)notification{
    //: __block BOOL result = NO;
    __block BOOL result = NO;
    //: io_sync_safe(^{
    avoidAssociation(^{
        //: if (notification)
        if (notification)
        {
            //: AttachMeasuredSuiteTranslateStatus status = notification.needBadge? AttachMeasuredSuiteTranslateStatusNone : AttachMeasuredSuiteTranslateStatusRead;
            AttachMeasuredSuiteTranslateStatus status = notification.point? AttachMeasuredSuiteTranslateStatusNone : AttachMeasuredSuiteTranslateStatusRead;
            //: NSString *sql = @"insert into notifications(timetag,sender,receiver,content,status)              values(?,?,?,?,?)";
            NSString *sql = StringFromDocumentData(commonSumSearchId);

            //: if (![self.db executeUpdate:sql,
            if (![self.checkIndex executeUpdate:sql,
                  //: @(notification.timestamp),
                  @(notification.player),
                  //: notification.sender,
                  notification.collectionWoman,
                  //: notification.receiver,
                  notification.throughout,
                  //: notification.content,
                  notification.moreDate,
                  //: @(status)])
                  @(status)])
            {
            }
            //: else
            else
            {
                //: notification.serial = (NSInteger)[self.db lastInsertRowId];
                notification.agree = (NSInteger)[self.checkIndex lastInsertRowId];
                //: if (notification.needBadge) {
                if (notification.point) {
                    //: self.unreadCount++;
                    self.album++;
                }
                //: result = YES;
                result = YES;
            }
        }
    //: });
    });
    //: return result;
    return result;

}


//: - (instancetype)init
- (instancetype)init
{
    //: if (self = [super init])
    if (self = [super init])
    {
        //: [self openDatabase];
        [self computerDatabase];
    }
    //: return self;
    return self;
}

//: - (NSArray *)fetchNotifications:(AddBelowDropPlace *)notification
- (NSArray *)messageLimit:(AddBelowDropPlace *)notification
                          //: limit:(NSInteger)limit{
                          minMinute:(NSInteger)limit{
    //: __block NSArray *result = nil;
    __block NSArray *result = nil;

    //: NSString *sql = nil;
    NSString *sql = nil;
    //: if (notification)
    if (notification)
    {
        //: sql = [NSString stringWithFormat:@"select * from notifications where timetag < %f and status != ? order by timetag desc limit ?",
        sql = [NSString stringWithFormat:StringFromDocumentData(colorPolicyError),
               //: notification.timestamp] ;
               notification.player] ;
    }
    //: else
    else
    {
        //: sql = @"select * from notifications where status != ? order by timetag desc limit ?";
        sql = StringFromDocumentData(spacingExecuteConfig);
    }
    //: io_sync_safe(^{
    avoidAssociation(^{
        //: NSMutableArray *array = [NSMutableArray array];
        NSMutableArray *array = [NSMutableArray array];
        //: FMResultSet *rs = [self.db executeQuery:sql,@(AttachMeasuredSuiteTranslateStatusDeleted),@(limit)];
        FMResultSet *rs = [self.checkIndex executeQuery:sql,@(AttachMeasuredSuiteTranslateStatusDeleted),@(limit)];
        //: while ([rs next])
        while ([rs next])
        {
            //: AddBelowDropPlace *notification = [[AddBelowDropPlace alloc] init];
            AddBelowDropPlace *notification = [[AddBelowDropPlace alloc] init];
            //: notification.serial = (NSInteger)[rs intForColumn:@"serial"];
            notification.agree = (NSInteger)[rs intForColumn:StringFromDocumentData(appReplacementValue)];
            //: notification.timestamp = [rs doubleForColumn:@"timetag"];
            notification.player = [rs doubleForColumn:StringFromDocumentData(spacingPartyKey)];
            //: notification.sender = [rs stringForColumn:@"sender"];
            notification.collectionWoman = [rs stringForColumn:StringFromDocumentData(themeDarkData)];
            //: notification.receiver = [rs stringForColumn:@"receiver"];
            notification.throughout = [rs stringForColumn:StringFromDocumentData(widgetAlongId)];
            //: notification.content = [rs stringForColumn:@"content"];
            notification.moreDate = [rs stringForColumn:StringFromDocumentData(viewVerseFormat)];
            //: [array addObject:notification];
            [array addObject:notification];
        }
        //: [rs close];
        [rs close];
        //: result = array;
        result = array;
    //: });
    });

    //: return result;
    return result;

}


//: - (void)deleteNotification:(AddBelowDropPlace *)notification{
- (void)spaceNotification:(AddBelowDropPlace *)notification{
    //: NSString *sql = @"update notifications set status  = ? where serial = ?";
    NSString *sql = StringFromDocumentData(themeTravelWatchKey);
    //: io_async(^{
    overlookTechnology(^{
        //: if (![self.db executeUpdate:sql,@(AttachMeasuredSuiteTranslateStatusDeleted),@(notification.serial)])
        if (![self.checkIndex executeUpdate:sql,@(AttachMeasuredSuiteTranslateStatusDeleted),@(notification.agree)])
        {
        }
        //: [self queryUnreadCount];
        [self brokerTotal];
    //: });
    });
}

//: static const void * const USERDispatchIOSpecificKey = &USERDispatchIOSpecificKey;
static const void * const k_waitError = &k_waitError;
//: dispatch_queue_t USERDispatchIOQueue()
dispatch_queue_t ringRest()
{
    //: static dispatch_queue_t queue;
    static dispatch_queue_t queue;
    //: static dispatch_once_t onceToken;
    static dispatch_once_t onceToken;
    //: _dispatch_once(&onceToken, ^{
    _dispatch_once(&onceToken, ^{
        //: queue = dispatch_queue_create("nim.demo.io.queue", 0);
        queue = dispatch_queue_create("nim.demo.io.queue", 0);
        //: dispatch_queue_set_specific(queue, USERDispatchIOSpecificKey, (void *)USERDispatchIOSpecificKey, NULL);
        dispatch_queue_set_specific(queue, k_waitError, (void *)k_waitError, NULL);
    //: });
    });
    //: return queue;
    return queue;
}


//: typedef void(^dispatch_block)(void);
typedef void(^dispatch_block)(void);
//: void io_sync_safe(dispatch_block block)
void avoidAssociation(dispatch_block block)
{
    //: if (dispatch_get_specific(USERDispatchIOSpecificKey))
    if (dispatch_get_specific(k_waitError))
    {
        //: block();
        block();
    }
    //: else
    else
    {
        //: dispatch_sync(USERDispatchIOQueue(), ^() {
        dispatch_sync(ringRest(), ^() {
            //: block();
            block();
        //: });
        });
    }
}


//: void io_async(dispatch_block block){
void overlookTechnology(dispatch_block block){
    //: dispatch_async(USERDispatchIOQueue(), ^() {
    dispatch_async(ringRest(), ^() {
        //: block();
        block();
    //: });
    });
}


//: @end
@end

Byte * DocumentDataToCache(Byte *data) {
    int peculiar = data[0];
    int pitchDark = data[1];
    Byte spacePolicy = data[2];
    int ledgeLake = data[3];
    if (!peculiar) return data + ledgeLake;
    for (int i = ledgeLake; i < ledgeLake + pitchDark; i++) {
        int value = data[i] - spacePolicy;
        if (value < 0) {
            value += 256;
        }
        data[i] = value;
    }
    data[0] = 0;
    data[ledgeLake + pitchDark] = 0;
    return data + ledgeLake;
}

NSString *StringFromDocumentData(Byte *data) {
    return [NSString stringWithUTF8String:(char *)DocumentDataToCache(data)];
}
